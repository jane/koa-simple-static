'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _crypto=require('crypto'),_fs=require('fs'),_zlib=require('zlib'),_path=require('path'),_mimeTypes=require('mime-types'),_compressible=require('compressible'),_compressible2=_interopRequireDefault(_compressible),_fsReaddirRecursive=require('fs-readdir-recursive'),_fsReaddirRecursive2=_interopRequireDefault(_fsReaddirRecursive),_koaRouter=require('koa-router');function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(c,d){function f(g,i){try{var j=b[g](i),k=j.value}catch(l){return void d(l)}return j.done?void c(k):Promise.resolve(k).then(function(l){f('next',l)},function(l){f('throw',l)})}return f('next')})}}var safeDecodeURIComponent=function(a){try{return decodeURIComponent(a)}catch(b){return a}},loadFile=function(a,b,c,d){var f=(0,_path.normalize)((0,_path.join)(c.prefix,a)),g=d[f]=d[f]?d[f]:{},i=g.path=(0,_path.join)(b,a),j=(0,_fs.statSync)(i),k=(0,_fs.readFileSync)(i);return g.cacheControl=c.cacheControl,g.maxAge=g.maxAge?g.maxAge:c.maxAge||0,g.type=g.mime=(0,_mimeTypes.lookup)(f)||'application/octet-stream',g.mtime=j.mtime,g.length=j.size,g.md5=(0,_crypto.createHash)('md5').update(k).digest('base64'),c.buffer&&(g.buffer=k),k=null,g},staticCache=function(a){var b=a.dir;a.prefix=(a.prefix||'').replace(/\/*$/,'/');var c={},d=!!a.gzip,f=(0,_path.normalize)(a.prefix.replace(/^\//,''));return!1!==a.preload&&(0,_fsReaddirRecursive2.default)(b).forEach(function(g){loadFile(g,b,a,c)}),function(){var g=_asyncToGenerator(regeneratorRuntime.mark(function i(j,k){var l,m,n,o,p,q,r,u;return regeneratorRuntime.wrap(function(w){for(;;)switch(w.prev=w.next){case 0:if('HEAD'===j.method||'GET'===j.method){w.next=4;break}return w.next=3,k();case 3:return w.abrupt('return');case 4:if(0===j.path.indexOf(a.prefix)){w.next=8;break}return w.next=7,k();case 7:return w.abrupt('return');case 8:if(a.extraHeaders&&Array.isArray(a.extraHeaders)&&a.extraHeaders.length&&a.extraHeaders.forEach(function(x){for(var y in x)j.append(y,x[y])}),l=safeDecodeURIComponent((0,_path.normalize)(j.path)),m=c[l],m){w.next=44;break}if(a.dynamic){w.next=16;break}return w.next=15,k();case 15:return w.abrupt('return');case 16:if('.'!==(0,_path.basename)(l)[0]){w.next=20;break}return w.next=19,k();case 19:return w.abrupt('return');case 20:if(l.charAt(0)===_path.sep&&(l=l.slice(1)),'/'===a.prefix){w.next=27;break}if(0===l.indexOf(f)){w.next=26;break}return w.next=25,k();case 25:return w.abrupt('return');case 26:l=l.slice(f.length);case 27:return n=void 0,w.prev=28,w.next=31,(0,_fs.statSync)((0,_path.join)(b,l));case 31:n=w.sent,w.next=39;break;case 34:return w.prev=34,w.t0=w['catch'](28),w.next=38,k();case 38:return w.abrupt('return');case 39:if(n.isFile()){w.next=43;break}return w.next=42,k();case 42:return w.abrupt('return');case 43:m=loadFile(l,b,a,c);case 44:if(j.status=200,d&&j.vary('Accept-Encoding'),m.buffer){w.next=51;break}return w.next=49,(0,_fs.statSync)(m.path);case 49:o=w.sent,o.mtime>m.mtime&&(m.mtime=o.mtime,m.md5=null,m.length=o.size);case 51:if(j.response.lastModified=m.mtime,m.md5&&(j.response.etag=m.md5),!j.fresh){w.next=56;break}return j.status=304,w.abrupt('return');case 56:if(j.type=m.type,j.length=m.zipBuffer?m.zipBuffer.length:m.length,j.set('cache-control',m.cacheControl||'public, max-age='+m.maxAge),m.md5&&j.set('content-md5',m.md5),'HEAD'!==j.method){w.next=62;break}return w.abrupt('return');case 62:if(p='gzip'===j.acceptsEncodings('gzip'),!m.zipBuffer){w.next=66;break}return p?(j.set('content-encoding','gzip'),j.body=m.zipBuffer):j.body=m.buffer,w.abrupt('return');case 66:if(q=d&&1024<m.length&&p&&(0,_compressible2.default)(m.type),!m.buffer){w.next=78;break}if(!q){w.next=76;break}return w.next=71,(0,_zlib.gzip)(m.buffer);case 71:m.zipBuffer=w.sent,j.set('content-encoding','gzip'),j.body=m.zipBuffer,w.next=77;break;case 76:j.body=m.buffer;case 77:return w.abrupt('return');case 78:r=(0,_fs.createReadStream)(m.path),m.md5||(u=(0,_crypto.createHash)('md5'),r.on('data',u.update.bind(u)),r.on('end',function(){m.md5=u.digest('base64')})),j.body=r,q&&(j.remove('content-length'),j.set('content-encoding','gzip'),j.body=r.pipe((0,_zlib.createGzip)()));case 82:case'end':return w.stop();}},i,void 0,[[28,34]])}));return function(){return g.apply(this,arguments)}}()};exports.default=staticCache;
