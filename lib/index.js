'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _crypto=require('crypto'),_fs=require('fs'),_zlib=require('zlib'),_path=require('path'),_mimeTypes=require('mime-types'),_compressible=require('compressible'),_compressible2=_interopRequireDefault(_compressible),_fsReaddirRecursive=require('fs-readdir-recursive'),_fsReaddirRecursive2=_interopRequireDefault(_fsReaddirRecursive),_koaRouter=require('koa-router');function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(c,d){function f(g,i){try{var j=b[g](i),k=j.value}catch(l){return void d(l)}return j.done?void c(k):Promise.resolve(k).then(function(l){f('next',l)},function(l){f('throw',l)})}return f('next')})}}var safeDecodeURIComponent=function(a){try{return decodeURIComponent(a)}catch(b){return a}},loadFile=function(a,b,c,d){var f=(0,_path.normalize)((0,_path.join)(c.prefix,a)),g=d[f]=d[f]?d[f]:{},i=g.path=(0,_path.join)(b,a),j=(0,_fs.statSync)(i),k=(0,_fs.readFileSync)(i);return g.cacheControl=c.cacheControl,g.maxAge=g.maxAge?g.maxAge:c.maxAge||0,g.type=g.mime=(0,_mimeTypes.lookup)(f)||'application/octet-stream',g.mtime=j.mtime,g.length=j.size,g.md5=(0,_crypto.createHash)('md5').update(k).digest('base64'),c.buffer&&(g.buffer=k),k=null,g},staticCache=function(a){var b=a.dir;a.prefix='/';var c={},d=!!a.gzip;return(0,_fsReaddirRecursive2.default)(b).forEach(function(f){loadFile(f,b,a,c)}),function(){var f=_asyncToGenerator(regeneratorRuntime.mark(function g(i,j){var k,l,m,n,o,p,q,r;return regeneratorRuntime.wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if('HEAD'===i.method||'GET'===i.method){v.next=4;break}return v.next=3,j();case 3:return v.abrupt('return');case 4:if(0===i.path.indexOf(a.prefix)){v.next=8;break}return v.next=7,j();case 7:return v.abrupt('return');case 8:if(a.extraHeaders&&Array.isArray(a.extraHeaders)&&a.extraHeaders.length&&a.extraHeaders.forEach(function(w){for(var x in w)i.append(x,w[x])}),k=safeDecodeURIComponent((0,_path.normalize)(i.path)),l=c[k],l){v.next=34;break}if('.'!==(0,_path.basename)(k)[0]){v.next=16;break}return v.next=15,j();case 15:return v.abrupt('return');case 16:return k.charAt(0)===_path.sep&&(k=k.slice(1)),m=void 0,v.prev=18,v.next=21,(0,_fs.statSync)((0,_path.join)(b,k));case 21:m=v.sent,v.next=29;break;case 24:return v.prev=24,v.t0=v['catch'](18),v.next=28,j();case 28:return v.abrupt('return');case 29:if(m.isFile()){v.next=33;break}return v.next=32,j();case 32:return v.abrupt('return');case 33:l=loadFile(k,b,a,c);case 34:if(i.status=200,d&&i.vary('Accept-Encoding'),l.buffer){v.next=41;break}return v.next=39,(0,_fs.statSync)(l.path);case 39:n=v.sent,n.mtime>l.mtime&&(l.mtime=n.mtime,l.md5=null,l.length=n.size);case 41:if(i.response.lastModified=l.mtime,l.md5&&(i.response.etag=l.md5),!i.fresh){v.next=46;break}return i.status=304,v.abrupt('return');case 46:if(i.type=l.type,i.length=l.zipBuffer?l.zipBuffer.length:l.length,i.set('cache-control',l.cacheControl||'public, max-age='+l.maxAge),l.md5&&i.set('content-md5',l.md5),'HEAD'!==i.method){v.next=52;break}return v.abrupt('return');case 52:if(o='gzip'===i.acceptsEncodings('gzip'),!l.zipBuffer){v.next=56;break}return o?(i.set('content-encoding','gzip'),i.body=l.zipBuffer):i.body=l.buffer,v.abrupt('return');case 56:if(p=d&&1024<l.length&&o&&(0,_compressible2.default)(l.type),!l.buffer){v.next=68;break}if(!p){v.next=66;break}return v.next=61,(0,_zlib.gzip)(l.buffer);case 61:l.zipBuffer=v.sent,i.set('content-encoding','gzip'),i.body=l.zipBuffer,v.next=67;break;case 66:i.body=l.buffer;case 67:return v.abrupt('return');case 68:q=(0,_fs.createReadStream)(l.path),l.md5||(r=(0,_crypto.createHash)('md5'),q.on('data',r.update.bind(r)),q.on('end',function(){l.md5=r.digest('base64')})),i.body=q,p&&(i.remove('content-length'),i.set('content-encoding','gzip'),i.body=q.pipe((0,_zlib.createGzip)()));case 72:case'end':return v.stop();}},g,void 0,[[18,24]])}));return function(){return f.apply(this,arguments)}}()};exports.default=staticCache;
